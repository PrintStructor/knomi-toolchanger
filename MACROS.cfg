# ==============================================================================
# VORON TOOLCHANGER — CORE PRINT MACROS
# ==============================================================================
#
# Author: PrintStructor
# GitHub: https://github.com/PrintStructor
# Version: 1.0.0
#
# Description:
#   Core macros for managing print workflows on the Voron Toolchanger.
#   Includes standardized print lifecycle management (start, end, pause, resume),
#   gantry leveling, homing procedures, and utility functions.
#
# Features:
#   - Intelligent print start sequence with bed heating & soaking
#   - Multi-stage Quad Gantry Leveling (coarse + fine)
#   - Adaptive bed meshing with Beacon contact probe
#   - Heat-safe pause/resume with toolchanger error handling
#   - Safe print cancellation with proper cleanup
#   - Emergency bed movement macros
#   - Aux fan control for Orca Slicer compatibility
#
# Structure:
#   1. Gantry Leveling & Homing
#   2. Print Lifecycle (Start/End/Pause/Resume/Cancel)
#   3. Utility Macros
#   4. Auxiliary Fans
#   5. Filament Management (Templates)
#
# Integration:
#   - Works with toolchanger_macros.cfg for tool management
#   - Uses KNOMI macros for display feedback
#   - Integrates with tc_led_effects.cfg for status LEDs
#   - Leverages beacon.cfg for probing & mesh
#
# Slicer Configuration:
#   Start G-Code:
#     PRINT_START BED_TEMP=[bed_temperature] TOOL_TEMP=[nozzle_temperature] INITIAL_TOOL=0
#   End G-Code:
#     PRINT_END
#   Cancel G-Code:
#     CANCEL_PRINT
#
# ==============================================================================

# ==============================================================================
# SECTION 1: GANTRY LEVELING & HOMING
# ==============================================================================

# ------------------------------------------------------------------------------
# Quad Gantry Leveling (QGL) - Enhanced Multi-Stage Approach
# ------------------------------------------------------------------------------
# Why: Ensures precise gantry alignment before every print
# How: Two-stage process (coarse + fine) for optimal accuracy
# When: Automatically called during PRINT_START

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: BASE_QUAD_GANTRY_LEVEL
description: Enhanced QGL with coarse and fine calibration stages
gcode:
    # Wake up KNOMI displays to show QGL progress
    KNOMI_WAKE

    # Set KNOMI status to indicate QGL is running
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=True

    {% if printer.quad_gantry_level.applied == False %}
        # First-time QGL: Start with coarse adjustment from safe height
        # This prevents probe crashes on severely unlevel gantries
        BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=0.015

        # Follow up with fine calibration for precision
        FINE_QUAD_GANTRY_LEVEL
    {% else %}
        # Gantry was already leveled: Only fine calibration needed
        FINE_QUAD_GANTRY_LEVEL
    {% endif %}

    # Reset KNOMI status after QGL completion
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=False

[gcode_macro FINE_QUAD_GANTRY_LEVEL]
description: Fine-precision QGL pass at low Z height
gcode:
    # Perform precise QGL at Z=2mm for better accuracy
    # Lower height = better probe consistency
    BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=2.0

# ------------------------------------------------------------------------------
# Homing Check
# ------------------------------------------------------------------------------
# Why: Prevents redundant homing operations
# What: Only homes if axes are not already homed

[gcode_macro CHECK_HOMING]
description: Check if axes are homed, home if needed
gcode:
    {% if 'x' in printer.toolhead.homed_axes and 'y' in printer.toolhead.homed_axes and 'z' in printer.toolhead.homed_axes %}
        M117 Axes already homed, skipping G28
    {% else %}
        STATUS_HOMING
        M117 Homing all axes...
        G28                                    # Home all axes
        G0 Z5                                  # Lift to safe height
        G90                                    # Absolute positioning
    {% endif %}

# ------------------------------------------------------------------------------
# G32 - Legacy Gantry Calibration Macro
# ------------------------------------------------------------------------------
# Why: Provides compatibility with legacy G-Code
# What: Ensures T0 is active, clears mesh, performs QGL, re-homes Z

[gcode_macro G32]
description: Legacy macro for gantry calibration (QGL + Z home)
gcode:
    # Ensure T0 is active for consistent probing
    {% if printer.toolchanger.tool is none %}
        M117 Activating T0 for QGL...
        T0
    {% endif %}

    BED_MESH_CLEAR                             # Clear any existing mesh
    QUAD_GANTRY_LEVEL                          # Perform QGL
    G28 Z                                      # Re-home Z after QGL

# ------------------------------------------------------------------------------
# Print Status (Debug)
# ------------------------------------------------------------------------------
# Why: Debug helper for checking printer object states

[gcode_macro PRINT_STATUS]
description: Display status of a printer object (debug)
gcode:
    RESPOND TYPE='echo' MSG="Status for {params.OBJ} is {printer[params.OBJ]}"

# ==============================================================================
# SECTION 2: PRINT LIFECYCLE MANAGEMENT
# ==============================================================================

# ------------------------------------------------------------------------------
# PRINT_START - Comprehensive Print Initialization
# ------------------------------------------------------------------------------
# Why: Prepares printer for optimal print quality
# What: Heats bed, performs QGL, meshes bed, heats tools
# Parameters:
#   - BED_TEMP: Target bed temperature (default: 110°C)
#   - TOOL_TEMP: Target tool temperature (default: 200°C)
#   - CHAMBER: Target chamber temperature (default: 40°C)
#   - INITIAL_TOOL: Tool to start with (default: 0)

[gcode_macro PRINT_START]
variable_printing: False
description: Comprehensive print start sequence with bed soak & calibration
gcode:
    # Wake up KNOMI displays
    KNOMI_WAKE

    # Parse parameters with defaults
    {% set target_bed = params.BED_TEMP|default(110)|int %}
    {% set target_extruder = params.TOOL_TEMP|default(200)|int %}
    {% set target_chamber = params.CHAMBER|default("40")|int %}
    {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
    {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
    {% set initial_tool = params.INITIAL_TOOL|default(0)|int %}

    # Initialize print state
    _ENABLE_FILAMENT_SENSORS
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    M117 Initializing...
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=False

    # Ensure homing and toolchanger initialization
    CHECK_HOMING
    G4 P500                                    # Wait 500ms for CAN MCU detection pins to settle
    INITIALIZE_TOOLCHANGER
    RESET_INITIAL_TOOL                         # Reset tool reference

    # Bed heating with optional soak period
    {% if target_bed > 80 %}
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}°C"
        STATUS_HEATING
        M106 S38                               # Enable part cooling at low speed
        G1 X{x_wait} Y{y_wait} Z2 F9000       # Move to center
        M190 S{target_bed}                     # Wait for bed temp
    {% else %}
        SET_DISPLAY_TEXT MSG="Bed: {target_bed}°C"
        STATUS_HEATING
        G1 X{x_wait} Y{y_wait} Z2 F9000
        M190 S{target_bed}
        SET_DISPLAY_TEXT MSG="Soaking bed for 5min..."
    {% endif %}

    # Select initial tool and preheat to probing temperature
    T{initial_tool}
    M117 Pre-heating T{initial_tool} to 180°C (probing temp)
    M109 S180                                  # Wait for probing temp

    # Calibrate Z-offset with hot nozzle for thermal expansion
    G28 Z METHOD=CONTACT CALIBRATE=1

    # Perform Quad Gantry Leveling
    STATUS_LEVELING
    M117 Quad Gantry Leveling...
    QUAD_GANTRY_LEVEL

    # Generate adaptive bed mesh
    M117 Generating bed mesh...
    STATUS_MESHING
    BED_MESH_CALIBRATE ADAPTIVE=1

    # Recalibrate Z after gantry & mesh adjustments
    G28 Z METHOD=CONTACT CALIBRATE=0

    # Heat tool to final printing temperature
    SET_DISPLAY_TEXT MSG="Heating T{initial_tool}..."
    STATUS_HEATING
    M117 Heating T{initial_tool} to {target_extruder}°C
    T{initial_tool}
    M109 S{target_extruder}

    # Final print preparation
    G0 Z2 F300
    G92 E0                                     # Reset extruder position
    SKEW_PROFILE LOAD=CaliFlower              # Load skew correction
    SET_INITIAL_TOOL TOOL={initial_tool}       # Initialize tool offsets correctly
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=True

    STATUS_PRINTING
    PRIME_LINE                                 # Purge nozzle

    # REMOVED: Old polling-based tool monitoring (replaced by event-driven system in tool.py)
    # UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=5.0

    M117 Printing...

# ------------------------------------------------------------------------------
# PRINT_END - Clean Print Completion
# ------------------------------------------------------------------------------
# Why: Safely ends print and prepares for next job
# What: Retracts filament, parks toolhead, cools down, resets offsets

[gcode_macro PRINT_END]
description: Clean print completion with safe toolhead parking
gcode:
    # REMOVED: Old polling-based tool monitoring (now event-driven in tool.py)
    # UPDATE_DELAYED_GCODE ID=TOOL_PRESENCE_MONITOR DURATION=0

    STATUS_PART_READY
    SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=printing VALUE=False
    SET_SKEW CLEAR=1                           # Clear skew correction
    M400                                       # Wait for buffer to clear
    G92 E0                                     # Zero extruder
    G1 E-4.0 F3600                            # Retract filament
    G91                                        # Relative positioning

    # Get machine boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Calculate safe movement directions
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    # Move to break stringing
    G0 X{x_safe} Y{y_safe} F20000             # XY wipe
    G0 Z{z_safe} F3600                         # Z lift

    # Shutdown heaters and fans
    TURN_OFF_HEATERS
    M107                                       # Part cooling fan off
    M140                                       # Bed heater off

    # Park toolhead
    G90                                        # Absolute positioning
    {% set tool = printer[printer.toolchanger.tool] %}
    G0 X{tool.params_park_x} Y{tool.params_safe_y} F3600

    M18                                        # Disable motors
    M117 Print finished!

    # Cleanup
    _DISABLE_FILAMENT_SENSORS
    BED_MESH_CLEAR
    RESET_INITIAL_TOOL                         # Reset tool reference
    SET_GCODE_OFFSET X=0 Y=0 Z=0 ABSOLUTE=1   # Clear all offsets

# ------------------------------------------------------------------------------
# PRIME_LINE - Nozzle Purge
# ------------------------------------------------------------------------------
# Why: Ensures consistent first layer by purging any inconsistent filament
# What: Draws two parallel lines at front of bed

[gcode_macro PRIME_LINE]
description: Purge nozzle by drawing prime lines at bed front
gcode:
    M117 Purging nozzle...
    # Move to start position
    G1 X10 Y5 Z0.36 F5000.0
    # Draw first line
    G1 X80.0 Y5 Z0.36 F1500.0 E30
    # Move slightly over
    G1 X80.0 Y5.2 Z0.36 F5000.0
    # Draw second line (back)
    G1 X10 Y5.2 Z0.36 F1500.0 E30
    # Reset extruder
    G92 E0
    # Lift nozzle
    G1 Z2.0 F3000

# ------------------------------------------------------------------------------
# Toolchanger-Aware PAUSE (overrides Mainsail)
# ------------------------------------------------------------------------------
# CRITICAL: Mainsail's PAUSE always parks, which causes collision during TC errors
# This override checks for toolchanger errors BEFORE parking
# NOTE: mainsail.cfg remains unchanged (read-only), we override here

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
description: Toolchanger-aware pause (prevents park during TC errors and tool loss)
gcode:
    {% set tc = printer.toolchanger if "toolchanger" in printer else {} %}
    {% set in_tc_error = (tc.status|default("") == "error") %}

    # Check for tool loss - active tool not detected
    {% set tool_lost = False %}
    {% if tc.tool_number is defined and tc.tool_number >= 0 %}
        {% set tool_name = "tool T" ~ tc.tool_number %}
        {% set tool_obj = printer[tool_name] if tool_name in printer else None %}
        {% if tool_obj and tool_obj.detect_state != 1 %}
            {% set tool_lost = True %}
        {% endif %}
    {% endif %}

    {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
    {% set idle_timeout = client.idle_timeout|default(0) %}
    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}

    # Save temperature for resume
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=last_extruder_temp VALUE="{{'restore': True, 'temp': temp}}"

    # Set idle timeout
    {% if idle_timeout > 0 %}
        SET_IDLE_TIMEOUT TIMEOUT={idle_timeout}
    {% endif %}

    # Always pause the print first
    PAUSE_BASE

    {% if in_tc_error or tool_lost %}
        # ============================================================
        # TOOLCHANGER ERROR OR TOOL LOSS: Do NOT park/retract
        # ============================================================
        # Toolhead may be at dock, or tool may be lost/missing
        # Any movement or retraction could cause collision or errors

        STATUS_ERROR
        {% if tool_lost %}
            M117 Tool lost - Paused (DO NOT MOVE!)
            M106 S0  # Turn off part cooling fan
            RESPOND TYPE=error MSG="⚠️ Tool loss detected during print!"
            RESPOND TYPE=error MSG="Staying at current position - do NOT attempt to park"
            RESPOND TYPE=error MSG="Follow recovery steps, then use RESUME"
        {% else %}
            M117 TC Error - Paused at dock (DO NOT MOVE!)
            M106 S0  # Turn off part cooling fan
            RESPOND TYPE=error MSG="⚠️ Toolchanger error detected!"
            RESPOND TYPE=error MSG="Toolhead is at DOCK - do NOT attempt to move manually"
            RESPOND TYPE=error MSG="Follow recovery steps, then use RESUME"
        {% endif %}

    {% else %}
        # ============================================================
        # NORMAL PAUSE: Use Mainsail's standard park behavior
        # ============================================================
        _TOOLHEAD_PARK_PAUSE_CANCEL {rawparams}

        # Update LED status
        {% if printer.toolchanger.tool_number is defined %}
            STATUS_PAUSE TOOL={printer.toolchanger.tool_number}
        {% else %}
            STATUS_PAUSE
        {% endif %}
    {% endif %}

# ------------------------------------------------------------------------------
# Toolchanger-Aware RESUME (overrides Mainsail)
# ------------------------------------------------------------------------------
# CRITICAL: Handles toolchanger error recovery with proper position restoration
# This override provides complete control over resume flow during TC errors
# NOTE: mainsail.cfg remains unchanged (read-only), we override here

[gcode_macro RESUME]
rename_existing: RESUME_BASE
variable_last_extruder_temp: {'restore': False, 'temp': 0}
description: Toolchanger-aware resume (handles TC error recovery and tool loss)
gcode:
    {% set tc = printer.toolchanger if "toolchanger" in printer else {} %}
    {% set from_tc_error = (tc.status|default("") == "error") %}

    # Check if recovering from tool loss (saved_target will be set)
    {% set saved_target = printer["gcode_macro _TOOLCHANGER_RESUME_HANDLER"].saved_target|default(0)|float %}
    {% set from_tool_loss = (saved_target > 0) %}

    {% if from_tc_error or from_tool_loss %}
        # ============================================================
        # TOOLCHANGER ERROR OR TOOL LOSS RECOVERY MODE
        # ============================================================
        {% if from_tool_loss %}
            M117 Recovering from tool loss...
        {% else %}
            M117 Recovering from toolchanger error...
        {% endif %}

        # Get extruder info for heating
        {% set th = printer.toolhead %}
        {% set ex_name = th.extruder if th.extruder in printer else "extruder" %}
        {% set ex = printer[ex_name] if ex_name in printer else None %}
        {% set Ttarget = (ex.target|float) if ex else 0.0 %}
        {% set Tnow = (ex.temperature|float) if ex else 0.0 %}

        # Determine target temperature from multiple sources (priority order):
        # 1. saved_target (from tool loss handler)
        # 2. last_extruder_temp (from PAUSE macro - TC error or tool loss)
        # 3. Current target (if still set)
        {% set last_temp_data = printer["gcode_macro RESUME"].last_extruder_temp|default({}) %}
        {% set last_temp = last_temp_data.temp|default(0)|float if last_temp_data.restore|default(False) else 0 %}
        {% set target_temp = saved_target if saved_target > 0 else (last_temp if last_temp > 0 else Ttarget) %}

        # Heat tool if needed
        {% if target_temp > 0 and Tnow < target_temp - 5 %}
            M117 Heating tool to {target_temp|round(1)}°C...
            RESPOND MSG="Heating {ex_name} from {Tnow|round(1)}°C to {target_temp|round(1)}°C"
            M109 S{target_temp}
        {% else %}
            RESPOND MSG="Tool already at temperature ({Tnow|round(1)}°C / {target_temp|round(1)}°C)"
        {% endif %}

        # Clear saved temperature after using it
        SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_RESUME_HANDLER VARIABLE=saved_target VALUE=0

        # Clear tool loss handler flag (allow future tool loss detections)
        SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_TOOL_LOSS_HANDLER VARIABLE=handler_active VALUE=0

        # ============================================================
        # CRITICAL: Different recovery for Tool Loss vs Pickup Error!
        # ============================================================
        # PICKUP ERROR: Must restore to position BEFORE toolchange started
        #               Uses INITIALIZE_TOOLCHANGER RECOVER=1 (Python safety layer)
        # TOOL LOSS:    Must restore to position WHERE TOOL WAS LOST (saved by PAUSE)
        #               Uses RESUME_BASE (standard Klipper resume)
        # ============================================================

        {% if from_tc_error %}
            # PICKUP ERROR RECOVERY (Python-first)
            M117 TC error recovery - calling Python recovery...
            RESPOND MSG="Using INITIALIZE_TOOLCHANGER RECOVER=1 for pickup error"
            # Python handles: position restore to pre-toolchange, gcode state, resume
            INITIALIZE_TOOLCHANGER RECOVER=1
            M117 TC error recovered
        {% elif from_tool_loss %}
            # TOOL LOSS RECOVERY (use PAUSE position)
            M117 Tool loss recovery - using saved position...
            RESPOND MSG="Using RESUME_BASE for tool loss (position saved by PAUSE)"
            # PAUSE already saved the position where tool was lost, RESUME_BASE restores it
            RESUME_BASE
            M117 Tool loss recovered
        {% endif %}

        # Restore LED status to printing
        {% if printer.toolchanger.tool_number is defined %}
            STATUS_PRINTING TOOL={printer.toolchanger.tool_number}
        {% else %}
            STATUS_PRINTING
        {% endif %}

    {% else %}
        # ============================================================
        # NORMAL RESUME: Use Mainsail's standard logic
        # ============================================================
        RESUME_BASE {rawparams}

        # Restore LED status to printing
        {% if printer.toolchanger.tool_number is defined %}
            STATUS_PRINTING TOOL={printer.toolchanger.tool_number}
        {% else %}
            STATUS_PRINTING
        {% endif %}
    {% endif %}

# ------------------------------------------------------------------------------
# Mainsail Integration Variables
# ------------------------------------------------------------------------------
# IMPORTANT: These variables hook into Mainsail's PAUSE/RESUME system
# NOTE: user_resume_macro is NOT used since we override RESUME directly

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos: False     # We'll override _TOOLHEAD_PARK_PAUSE_CANCEL instead
variable_custom_park_x: 0.0
variable_custom_park_y: 0.0
variable_custom_park_dz: 2.0
variable_retract: 2.0
variable_cancel_retract: 5.0
variable_speed_retract: 35.0
variable_unretract: 2.0
variable_speed_unretract: 35.0
variable_speed_hop: 15.0
variable_speed_move: 100.0
variable_park_at_cancel: False
variable_park_at_cancel_x: None
variable_park_at_cancel_y: None
variable_use_fw_retract: False
variable_idle_timeout: 0
variable_runout_sensor: ""
variable_user_pause_macro: ""
variable_user_resume_macro: ""
variable_user_cancel_macro: ""
gcode:

# ------------------------------------------------------------------------------
# Safe Park Position (Dynamic Calculation)
# ------------------------------------------------------------------------------
# Override Mainsail's park macro with configurable position
# Default: Parks at active tool's X (dock aligned) and Y=safe_y (before docks)
# Custom: Set use_custom_pos=True in _CLIENT_VARIABLE to use custom_park_x/y

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Parks toolhead at tool's X position and safe_y (dock-aligned parking)
gcode:
    # Get max positions from config
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Get client variables
    {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
    {% set use_custom_pos = client.use_custom_pos|default(False) %}
    {% set custom_park_x = client.custom_park_x|default(0.0)|float %}
    {% set custom_park_y = client.custom_park_y|default(0.0)|float %}

    # Get tool info for dynamic parking position
    {% set tc = printer.toolchanger if "toolchanger" in printer else None %}
    {% if tc and tc.tool_number >= 0 %}
        {% set tool_name = "tool T" ~ tc.tool_number %}
        {% set tool = printer[tool_name] %}
    {% else %}
        # Fallback if no tool active: use T0
        {% set tool = printer["tool T0"] %}
    {% endif %}

    # Determine park position
    {% if use_custom_pos %}
        # User-configured position
        {% set park_x = custom_park_x %}
        {% set park_y = custom_park_y %}
    {% else %}
        # Default: Park at active tool's X position and safe_y limit
        # This aligns with the tool's dock X position for safe parking
        {% set park_x = tool.params_park_x|float %}
        {% set park_y = tool.params_safe_y|float %}
    {% endif %}

    # Get other client variables for park_dz and speeds
    {% set park_dz = client.custom_park_dz|default(2.0)|float %}
    {% set speed_hop = client.speed_hop|default(15.0)|float * 60 %}
    {% set speed_move = client.speed_move|default(100.0)|float * 60 %}
    {% set retract = client.retract|default(2.0)|float %}
    {% set speed_retract = client.speed_retract|default(35.0)|float * 60 %}

    # Get current position
    {% set current_z = printer.toolhead.position.z %}
    {% set target_z = current_z + park_dz %}

    # Limit Z to max
    {% if target_z > max_z %}
        {% set target_z = max_z %}
    {% endif %}

    # Save current position for resume
    SAVE_GCODE_STATE NAME=PAUSE_STATE

    # Set to absolute positioning
    G90

    # Retract filament
    {% if printer.extruder.can_extrude %}
        M83
        G1 E-{retract} F{speed_retract}
    {% endif %}

    # Lift Z
    {% if current_z < max_z %}
        G1 Z{target_z} F{speed_hop}
    {% endif %}

    # Park XY
    G1 X{park_x} Y{park_y} F{speed_move}

    {% if use_custom_pos %}
        RESPOND MSG="Parked at X{park_x|round(0)} Y{park_y|round(0)} Z{target_z|round(1)} (custom position)"
    {% else %}
        RESPOND MSG="Parked at X{park_x|round(0)} Y{park_y|round(0)} Z{target_z|round(1)} ({tool.tool_number} dock-aligned, safe_y)"
    {% endif %}

# ------------------------------------------------------------------------------
# Internal Helper - Temperature Storage for Tool Loss Handler
# ------------------------------------------------------------------------------
# This macro only exists to store the saved_target variable
# The actual RESUME logic is in the RESUME macro above

[gcode_macro _TOOLCHANGER_RESUME_HANDLER]
variable_saved_target: 0
description: Internal helper - stores temperature for tool loss recovery
gcode:
    # This macro is only used for variable storage
    # The _TOOLCHANGER_TOOL_LOSS_HANDLER stores temperature here
    # The RESUME macro reads it during TC error recovery
    RESPOND MSG="_TOOLCHANGER_RESUME_HANDLER: saved_target = {printer['gcode_macro _TOOLCHANGER_RESUME_HANDLER'].saved_target}"

# ------------------------------------------------------------------------------
# Toolchanger-Aware CANCEL_PRINT (overrides Mainsail)
# ------------------------------------------------------------------------------
# CRITICAL: Provides complete cleanup and reset for toolchanger system
# NOTE: mainsail.cfg remains unchanged (read-only), we override here

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Safe print cancellation with toolchanger system reset
gcode:
    # Get active tool for parking position
    {% set tc = printer.toolchanger if "toolchanger" in printer else None %}
    {% set tool = printer[tc.tool] if tc and tc.tool else printer["tool T0"] %}

    # Turn off heaters immediately
    TURN_OFF_HEATERS
    M106 S0  # Turn off part cooling fan

    # Clear pause state and SD card
    CLEAR_PAUSE
    SDCARD_RESET_FILE

    # Call base cancel to clear klipper's internal state
    CANCEL_PRINT_BASE

    # Get machine boundaries for safe moves
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Calculate safe relative moves (move 20mm away from current position)
    # Z respects max_z limit (lifts 20mm OR only to max_z, whichever is less)
    {% set th = printer.toolhead %}
    {% set x_safe = 20.0 if th.position.x < (max_x - 20) else -20.0 %}
    {% set y_safe = 20.0 if th.position.y < (max_y - 20) else -20.0 %}
    {% set z_safe = 20.0 if th.position.z < (max_z - 20) else (max_z - th.position.z) %}

    # Clear bed mesh
    BED_MESH_CLEAR

    # Perform safe moves if homed
    {% if 'xyz' in th.homed_axes %}
        G91                                        # Relative positioning
        G1 Z{z_safe} F3600                        # Lift Z first
        G1 X{x_safe} Y{y_safe} F20000             # Move away from part
        G90                                        # Absolute positioning
        G0 X{tool.params_park_x} Y{tool.params_safe_y} F3600  # Park at tool's position
    {% endif %}

    # Disable motors
    M84

    # Reset toolchanger system
    _DISABLE_FILAMENT_SENSORS
    SET_SKEW CLEAR=1
    RESET_INITIAL_TOOL
    SET_GCODE_OFFSET X=0 Y=0 Z=0 ABSOLUTE=1

    # Clear tool loss handler flags
    SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_TOOL_LOSS_HANDLER VARIABLE=handler_active VALUE=0
    SET_GCODE_VARIABLE MACRO=_TOOLCHANGER_RESUME_HANDLER VARIABLE=saved_target VALUE=0

    # Update LED status
    {% if "STATUS_READY" in printer.gcode.commands %}
        STATUS_READY
    {% endif %}

    M117 Print canceled

# NOTE: PAUSE, RESUME, and CANCEL_PRINT are overridden above for toolchanger awareness

# ==============================================================================
# SECTION 3: UTILITY MACROS
# ==============================================================================

[gcode_macro DISABLE_MOTORS]
description: Disable all stepper motors
gcode:
    M18

# ------------------------------------------------------------------------------
# Debug Tool Detection
# ------------------------------------------------------------------------------

[gcode_macro DEBUG_TOOL_DETECTION]
description: Display current tool detection status for debugging
gcode:
    RESPOND MSG="=== TOOL DETECTION DEBUG ==="
    RESPOND MSG="Print State: {printer.print_stats.state}"
    RESPOND MSG="TC Status: {printer.toolchanger.status}"
    RESPOND MSG="TC Has Detection: {printer.toolchanger.has_detection}"
    RESPOND MSG="Current Tool: {printer.toolchanger.tool.name if printer.toolchanger.tool else 'None'}"
    RESPOND MSG="Detected Tool: {printer.toolchanger.detected_tool.name if printer.toolchanger.detected_tool else 'None'}"
    {% for tool_num in printer.toolchanger.tool_numbers %}
        {% set tool = printer['tool T' + tool_num|string] %}
        RESPOND MSG="T{tool_num} detect_state: {tool.detect_state}"
    {% endfor %}

# ------------------------------------------------------------------------------
# Emergency Bed Movement (Use with Extreme Caution!)
# ------------------------------------------------------------------------------
# ⚠️ WARNING: These macros bypass homing and safety checks
# Only use when absolutely necessary (e.g., removing stuck prints)

[gcode_macro UNSAFE_LOWER_BED_100]
description: ⚠️ UNSAFE: Lower bed 100mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=100
    G0 Z0 F600
    M84

[gcode_macro UNSAFE_LOWER_BED_10]
description: ⚠️ UNSAFE: Lower bed 10mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=10
    G0 Z0 F600
    M84

[gcode_macro UNSAFE_RAISE_BED_100]
description: ⚠️ UNSAFE: Raise bed 100mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=0
    G0 Z100 F600
    M84

[gcode_macro UNSAFE_RAISE_BED_10]
description: ⚠️ UNSAFE: Raise bed 10mm without homing
gcode:
    G90
    SET_KINEMATIC_POSITION Z=0
    G0 Z10 F600
    M84

# ==============================================================================
# SECTION 4: AUXILIARY FANS (Orca Slicer Compatibility)
# ==============================================================================
# Why: Orca Slicer uses M106 with P parameter for aux fans
# What: Bridges M106 to Klipper's SET_FAN_SPEED

[gcode_macro M106]
description: Set fan speed with Orca Slicer P parameter support
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    SET_FAN_SPEED FAN={fan} SPEED={speed}

# ==============================================================================
# SECTION 5: FILAMENT MANAGEMENT (Templates - Disabled)
# ==============================================================================
# The following macros are provided as templates for filament change workflows.
# Uncomment and customize as needed for your setup.

#[gcode_macro M600]
#description: Filament change - pauses, parks, retracts 50mm
#gcode:
#    {% set X = params.X|default(5)|float %}
#    {% set Y = params.Y|default(310)|float %}
#    {% set Z = params.Z|default(10)|float %}
#    SAVE_GCODE_STATE NAME=M600_state
#    PAUSE
#    G91
#    G1 E-.8 F2700
#    G1 Z{Z}
#    G90
#    G1 X{X} Y{Y} F3000
#    G91
#    G1 E-50 F1000
#    RESTORE_GCODE_STATE NAME=M600_state

#[gcode_macro LOAD_FILAMENT]
#description: Load filament with heating and extrusion
#variable_ignore_min_extrude_temp: True
#gcode:
#    M117 Loading filament...
#    M104 S240
#    G90
#    G1 X100 Y20 Z20 F1800
#    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
#    M83
#    G1 E50 F300
#    G1 E50 F300
#    G1 E-4 F1800
#    M82
#    M400
#    M104 S0
#    M117 Loading done

#[gcode_macro UNLOAD_FILAMENT]
#description: Unload filament with heating and retraction
#variable_ignore_min_extrude_temp: True
#gcode:
#    M117 Unloading filament...
#    M104 S240
#    TEMPERATURE_WAIT SENSOR={printer.toolhead.extruder} MINIMUM=240
#    M83
#    G1 E5 F500
#    G1 E-50 F1000
#    G1 E-50 F1000
#    M82
#    M400
#    TURN_OFF_HEATERS
#    M117 Unloading done

#[gcode_macro UNLOAD_ONE_FILAMENT]
#description: Unload filament from specific tool
#gcode:
#    M117 Unloading {params.TOOL}
#    M109 T{params.TOOL} S240
#    {% set tool_name = printer.toolchanger.tool_names[params.TOOL|int] %}
#    {% set extruder = printer[tool_name].extruder %}
#    TEMPERATURE_WAIT SENSOR={extruder} MINIMUM=240
#    ACTIVATE_EXTRUDER EXTRUDER={extruder}
#    M83
#    G1 E5 F500
#    G1 E-50 F1000
#    G1 E-50 F1000
#    M82
#    M400
#    TURN_OFF_HEATERS
#    M117 Unloading done

#[gcode_macro UNLOAD_ALL_FILAMENT]
#description: Unload filament from all tools sequentially
#gcode:
#    {% set tools = printer.toolchanger.tool_names %}
#    M117 Unloading all tools...
#    {% for tool in tools %}
#        M104 T{printer[tool].tool_number} S240
#    {% endfor %}
#    {% for tool in tools %}
#        M109 T{printer[tool].tool_number} S240
#        ACTIVATE_EXTRUDER EXTRUDER={printer[tool].extruder}
#        M83
#        G1 E5 F500
#        G1 E-50 F1000
#        G1 E-50 F1000
#    {% endfor %}
#    M400
#    M82
#    TURN_OFF_HEATERS
#    M117 Unloading done
