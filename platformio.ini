; KNOMI V2 - platformio.ini Referenz
; Mit LittleFS + 16MB Flash + NOOTA Partition

[platformio]
default_envs = knomiv2

[env]
framework = arduino
monitor_speed = 115200
upload_speed = 921600

; Build-Flags für alle Environments
build_flags = 
    -DCORE_DEBUG_LEVEL=0
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -Os  ; Optimize for size

[env:knomiv2]
platform = espressif32 @ ^6.4.0
board = esp32s3box
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = qio
board_build.arduino.memory_type = qio_opi

; ========================================================================
; WICHTIG: 16MB Flash + LittleFS + NOOTA Partition
; ========================================================================
board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216
board_build.partitions = partitions_16mb_noota.csv
board_build.filesystem = littlefs  ; ← LittleFS aktivieren!

; ========================================================================
; Library Dependencies
; ========================================================================
lib_deps = 
    lvgl/lvgl@^8.3.7
    https://github.com/lvgl/lv_lib_gif/archive/refs/heads/master.zip  ; LVGL GIF Support
    bblanchon/ArduinoJson@^6.21.3
    LIS2DW12=https://github.com/stm32duino/LIS2DW12/archive/refs/tags/2.1.0.zip
    Adafruit_SHT4X=https://github.com/adafruit/Adafruit_SHT4X/archive/refs/tags/1.0.3.zip
    TFT_eSPI=https://github.com/Bodmer/TFT_eSPI/archive/refs/tags/v2.5.0.zip
    ottowinter/ESPAsyncWebServer-esphome @ ^3.0.0
    https://github.com/bigtreetech/AsyncElegantOTA.git
    AsyncTCP=esphome/AsyncTCP-esphome@^2.1.1

; ========================================================================
; Build-Flags spezifisch für KNOMI
; ========================================================================
build_flags = 
    ${env.build_flags}
    -DLVGL_BUFFER_SIZE=240*40  ; LVGL Display Buffer
    -DLV_MEM_SIZE="(128U * 1024U)"  ; 128KB LVGL Memory
    -DLV_USE_LOG=1  ; LVGL Logging für Debug
    -DLOG_LOCAL_LEVEL=ESP_LOG_VERBOSE

; Optional: Debug-Flags (auskommentieren für Produktion)
; build_flags = 
;     ${env.build_flags}
;     -DCORE_DEBUG_LEVEL=5  ; Verbose Debug

; ========================================================================
; Upload-Settings
; ========================================================================
upload_protocol = esptool
upload_port = COM3  ; ← Anpassen für dein System! (Windows: COM3, Mac: /dev/cu.usbserial-*, Linux: /dev/ttyUSB0)

; ========================================================================
; Monitor-Settings
; ========================================================================
monitor_filters = 
    colorize
    esp32_exception_decoder
monitor_port = COM3  ; ← Wie upload_port

; ========================================================================
; Custom Targets für LittleFS
; ========================================================================
; Verwendung:
;   pio run -t buildfs    # Baut LittleFS-Image aus data/ Ordner
;   pio run -t uploadfs   # Flasht LittleFS-Image zum ESP32

extra_scripts = 
    ; Automatisch von PlatformIO für LittleFS bereitgestellt

; ========================================================================
; NOTES:
; ========================================================================
; 1. Vor dem ersten Flash: pio run -t erase
; 2. Firmware bauen: pio run
; 3. Firmware flashen: pio run -t upload
; 4. LittleFS bauen: pio run -t buildfs
; 5. LittleFS flashen: pio run -t uploadfs
; 6. Monitor: pio device monitor
;
; Datei-Struktur:
;   KNOMI/firmware/
;   ├── data/
;   │   └── gifs/
;   │       ├── tool_0.gif
;   │       ├── tool_1.gif
;   │       ├── ...
;   │       └── tool_5.gif
;   ├── src/
;   │   ├── fs_gif_loader.cpp
;   │   ├── fs_gif_loader.h
;   │   └── ...
;   ├── partitions_16mb_noota.csv
;   └── platformio.ini (diese Datei)