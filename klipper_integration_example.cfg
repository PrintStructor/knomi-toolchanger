# ==============================================================================
# KNOMI Display Integration Examples for Klipper Macros
# ==============================================================================
#
# This file contains integration examples showing how to add KNOMI status flags
# to your existing Klipper macros. DO NOT include this file directly.
# Instead, copy the relevant sections into your own macros.
#
# Requirements:
# - Include KNOMI.cfg in your printer.cfg
# - The _KNOMI_STATUS macro must be defined (from KNOMI.cfg)
#
# Available Status Flags:
# - homing: Display shows homing animation
# - probing: Display shows bed mesh calibration animation
# - qgling: Display shows quad gantry level animation
# - heating_nozzle: Display shows nozzle heating animation
# - heating_bed: Display shows bed heating animation
# - printing: Display shows print progress overlay
# - paused: Display shows paused state
#
# ==============================================================================

# ------------------------------------------------------------------------------
# Example 1: QUAD_GANTRY_LEVEL Integration
# ------------------------------------------------------------------------------
# Shows how to wrap your existing QGL macro with KNOMI status flags

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: BASE_QUAD_GANTRY_LEVEL
description: QGL with KNOMI display integration
gcode:
    # Set qgling flag to show QGL animation on display
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=True

    # Your QGL logic here
    {% if printer.quad_gantry_level.applied == False %}
        BASE_QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=10 RETRY_TOLERANCE=0.015
        # Optional: Add fine calibration stage
        # FINE_QUAD_GANTRY_LEVEL
    {% else %}
        BASE_QUAD_GANTRY_LEVEL
    {% endif %}

    # Clear qgling flag when done
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=qgling VALUE=False

# ------------------------------------------------------------------------------
# Example 2: PRINT_START Integration
# ------------------------------------------------------------------------------
# Shows how to set printing flag during print start sequence

[gcode_macro PRINT_START]
description: Print start sequence with KNOMI integration
gcode:
    {% set target_bed = params.BED_TEMP|default(110)|int %}
    {% set target_extruder = params.TOOL_TEMP|default(200)|int %}

    # Wake displays if asleep
    KNOMI_WAKE

    # Your print start sequence here
    M117 Starting print...

    # Heat bed (will automatically show heating_bed animation via M190 wrapper)
    M190 S{target_bed}

    # Heat nozzle (will automatically show heating_nozzle animation via M109 wrapper)
    M109 S{target_extruder}

    # Home and level
    G28  # Shows homing animation via G28 wrapper
    QUAD_GANTRY_LEVEL  # Shows qgling animation via example above

    # Set printing flag - this shows the print progress overlay
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=printing VALUE=True

    M117 Printing...

# ------------------------------------------------------------------------------
# Example 3: PRINT_END Integration
# ------------------------------------------------------------------------------
# Shows how to clear printing flag and return to idle state

[gcode_macro PRINT_END]
description: Print end sequence with KNOMI integration
gcode:
    # Clear printing flag - returns display to idle/standby
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=printing VALUE=False

    # Your print end sequence here
    M400  # Wait for moves to finish
    G92 E0  # Reset extruder
    G1 E-2.0 F3600  # Retract

    # Turn off heaters
    M104 S0  # Extruder off
    M140 S0  # Bed off

    M117 Print complete!

# ------------------------------------------------------------------------------
# Example 4: PAUSE Integration (Toolchanger-Aware)
# ------------------------------------------------------------------------------
# Shows advanced pause logic that prevents parking during toolchanger errors

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
description: Toolchanger-aware pause with KNOMI integration
gcode:
    {% set tc = printer.toolchanger if "toolchanger" in printer else {} %}
    {% set in_tc_error = (tc.status|default("") == "error") %}

    # Check if tool is lost
    {% set tool_lost = False %}
    {% if tc.tool_number is defined and tc.tool_number >= 0 %}
        {% set tool_name = "tool T" ~ tc.tool_number %}
        {% set tool_obj = printer[tool_name] if tool_name in printer else None %}
        {% if tool_obj and tool_obj.detect_state != 1 %}
            {% set tool_lost = True %}
        {% endif %}
    {% endif %}

    # Execute base pause
    PAUSE_BASE

    # Set paused flag for KNOMI display
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=paused VALUE=True

    # Conditional parking based on toolchanger state
    {% if in_tc_error or tool_lost %}
        # Do NOT park - toolhead at dock or tool lost
        {% if tool_lost %}
            M117 Tool lost - Paused (DO NOT MOVE!)
        {% else %}
            M117 TC Error - Paused at dock
        {% endif %}
    {% else %}
        # Safe to park
        _TOOLHEAD_PARK_PAUSE_CANCEL {rawparams}
    {% endif %}

# ------------------------------------------------------------------------------
# Example 5: RESUME Integration
# ------------------------------------------------------------------------------

[gcode_macro RESUME]
rename_existing: RESUME_BASE
description: Resume with KNOMI integration
gcode:
    # Clear paused flag
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=paused VALUE=False

    # Your resume logic here
    {% if printer["gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL"].restore_idle_timeout > 0 %}
        SET_IDLE_TIMEOUT TIMEOUT={printer["gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL"].restore_idle_timeout}
    {% endif %}

    RESUME_BASE {rawparams}

# ------------------------------------------------------------------------------
# Example 6: CANCEL_PRINT Integration
# ------------------------------------------------------------------------------

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Cancel print with KNOMI integration
gcode:
    # Clear all KNOMI status flags
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=printing VALUE=False
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=paused VALUE=False

    # Your cancel logic here
    M400  # Wait for moves to finish
    G92 E0
    G1 E-2.0 F3600

    # Turn off heaters
    M104 S0
    M140 S0

    # Execute base cancel
    CANCEL_PRINT_BASE

    M117 Print cancelled

# ==============================================================================
# Notes:
# ==============================================================================
#
# 1. The G28, M109, M190, and BED_MESH_CALIBRATE wrappers are already defined
#    in KNOMI.cfg - you don't need to redefine them.
#
# 2. If you already have QUAD_GANTRY_LEVEL defined in your macros, just add
#    the SET_GCODE_VARIABLE lines at the beginning and end.
#
# 3. The printing flag is the most important - it triggers the print progress
#    overlay on the display.
#
# 4. All flags are automatically cleared when the display returns to idle state.
#
# 5. For toolchanger setups, the PAUSE example shows how to prevent parking
#    during tool loss or docking errors.
#
# ==============================================================================
