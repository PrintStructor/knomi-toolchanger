[gcode_macro _KNOMI_STATUS]
variable_homing: False
variable_probing: False
variable_qgling: False
variable_heating_nozzle: False
variable_heating_bed: False
variable_printing: False
variable_paused: False
gcode:

# ==============================================================================
# SECTION 2.5: RESTART COMMANDS - HTTP API INTEGRATION (v1.1.0+)
# ==============================================================================

# ------------------------------------------------------------------------------
# Restart Command (Single Display with Retry)
# ------------------------------------------------------------------------------
[gcode_shell_command knomi_restart_single]
# Restart a single KNOMI display via HTTP API (with retry)
# Usage: Called from RESTART_KNOMI macro with dynamic URL
# Command: Executes curl with URL passed as parameter
# Timeout: 2s connect + 5s max time, 3 retries with 0.3s delay
command: sh -c
timeout: 10.0
verbose: False

# ------------------------------------------------------------------------------
# Restart All Displays (Parallel with Retry)
# ------------------------------------------------------------------------------
[gcode_shell_command knomi_restart_all_retry]
# Restart all KNOMI displays in parallel (with retry)
# Command: Loop through all 6 displays (T0-T5), send restart command with 3 retries
# mDNS names: knomi-t0.local through knomi-t5.local
# Timeout: 2s connect + 5s max time per attempt
command: sh -c 'for i in 0 1 2 3 4 5; do (for retry in 1 2 3; do curl -X POST --connect-timeout 2 --max-time 5 http://knomi-t$i.local/api/restart 2>/dev/null && break || sleep 0.3; done) & done; wait'
timeout: 30.0
verbose: False

# ==============================================================================
# RESTART CONTROL MACROS
# ==============================================================================

[gcode_macro RESTART_KNOMI]
description: Restart a single KNOMI display remotely (no power cycle needed)
# Usage: RESTART_KNOMI TOOL=0  (default: T0)
# Requires: KNOMI firmware v1.1.0+
gcode:
    {% set tool = params.TOOL|default(0)|int %}
    {% set url = "http://knomi-t" ~ tool ~ ".local/api/restart" %}

    # User feedback
    RESPOND MSG="ðŸ”„ Restarting KNOMI T{tool} via HTTP API..."

    # Execute curl with 3 retries
    RUN_SHELL_COMMAND CMD=knomi_restart_single PARAMS="'for retry in 1 2 3; do curl -X POST --connect-timeout 2 --max-time 5 {url} 2>/dev/null && break || sleep 0.3; done'"

    # Wait briefly for restart
    G4 P2000

    # Confirmation
    RESPOND MSG="âœ… KNOMI T{tool} restart command sent"

[gcode_macro RESTART_ALL_KNOMI]
description: Restart all 6 KNOMI displays in parallel
# Usage: RESTART_ALL_KNOMI
# Requires: KNOMI firmware v1.1.0+
gcode:
    RESPOND MSG="ðŸ”„ Restarting all KNOMI displays in parallel..."
    RUN_SHELL_COMMAND CMD=knomi_restart_all_retry

    # Wait for restarts to complete
    G4 P3000

    RESPOND MSG="âœ… All KNOMI displays restart commands sent"

[gcode_macro RECOVER_KNOMI]
description: Try to recover an unresponsive KNOMI display with multiple attempts
# Usage: RECOVER_KNOMI TOOL=0
# Attempts restart multiple times if display is stuck
gcode:
    {% set tool = params.TOOL|default(0)|int %}

    RESPOND MSG="ðŸ”§ Attempting to recover KNOMI T{tool}..."

    # Try 3 times with longer wait between attempts
    RESTART_KNOMI TOOL={tool}
    G4 P5000
    RESTART_KNOMI TOOL={tool}
    G4 P5000
    RESTART_KNOMI TOOL={tool}

    RESPOND MSG="âœ… Recovery attempts completed for KNOMI T{tool}"

[gcode_macro G28]
rename_existing: G28.1
gcode:
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True
    G28.1 {rawparams}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False

[gcode_macro M109]
rename_existing: M109.1
gcode:
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=True
    M109.1 {rawparams}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_nozzle VALUE=False

[gcode_macro M190]
rename_existing: M190.1
gcode:
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=True
    M190.1 {rawparams}
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=heating_bed VALUE=False

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BTT_BED_MESH_CALIBRATE
gcode:
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True
    BTT_BED_MESH_CALIBRATE
    SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False

# For QUAD_GANTRY_LEVEL integration example, see klipper_integration_example.cfg
# (Shows how to add KNOMI status flags to your existing QGL macro)
